<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes Chile - Web</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Shepherd.js para tour interactivo -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@11.2.0/dist/css/shepherd.css"/>
    <link rel="stylesheet" href="/reportes/css/style.css">
    <link href="/assets_flexstart/img/favicon.png" rel="icon">
</head>
<body>
    <!-- Página de carga inicial -->
    <div id="initial-loading" class="loading-overlay" style="display: flex;">
        <div class="loading-content">
            <div class="loading-spinner">
                <div class="water-container">
                    <div class="water-surface"></div>
                    <div class="water-reflection"></div>
                    <div class="water-ripples"></div>
                </div>
                <div class="bubble"></div>
                <div class="bubble"></div>
                <div class="bubble"></div>
                <div class="bubble"></div>
                <div class="loading-percentage">0%</div>
            </div>
            <p class="loading-message">Iniciando Reportes...</p>
            <p class="loading-submessage">Esperando que el servidor esté listo</p>
        </div>
    </div>

    <!-- Overlay de Carga -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content-modern">
            <h3 id="loading-title" class="loading-title">Cargando datos</h3>

            <!-- Contenedor de cards apiladas con eventos en tiempo real -->
            <div id="events-stack" class="events-stack">
                <!-- Las cards se añaden dinámicamente vía JavaScript desde los eventos SSE -->
            </div>

            <!-- Botón de cancelar -->
            <button id="cancel-load-btn" class="btn-cancel-load" style="display: none;">
                <i class="bi bi-x-circle"></i> Cancelar carga
            </button>
        </div>
    </div>

    <header class="app-header text-white text-start py-3 shadow-sm d-flex justify-content-between align-items-center">
    <h1 class="ps-4 mb-0"><i class="bi bi-bar-chart-line-fill me-2"></i><span id="header-title-text"></span></h1>
    <img src="/reportes/assets/logo.png" alt="Publicación & contenido" id="app-logo">
</header>

    <div class="container-fluid mt-3 mb-4">
        <section id="data-source-section" class="card shadow-sm mb-3">
            <div class="card-body d-flex align-items-center flex-wrap gap-2 p-2">
                <div class="flex-grow-1">
                    <label for="country-select" class="form-label visually-hidden">País:</label>
                    <select id="country-select" class="form-select form-select-sm" aria-label="Seleccionar país"
                            data-bs-toggle="tooltip"
                            data-bs-placement="bottom"
                            title="Selecciona el país de la fuente de datos a consultar">
                    </select>
                </div>
                <div class="flex-grow-1">
                    <label for="blob-select" class="form-label visually-hidden">Fuente de Datos:</label>
                    <select id="blob-select" class="form-select form-select-sm" aria-label="Seleccionar fuente de datos"
                            data-bs-toggle="tooltip"
                            data-bs-placement="bottom"
                            title="Elige la fuente de datos específica que deseas consultar"></select>
                    <div id="sharepoint-auth-notice" class="form-text small text-muted mt-1" style="display: none;">
                        <i class="bi bi-info-circle-fill"></i> Para fuentes de SharePoint, es posible que se te pida iniciar sesión con tu cuenta de empresa.
                    </div>
                </div>
                
                <!-- Botón de carga simplificado -->
                <button id="load-data-btn" class="btn btn-primary-action btn-sm"
                        disabled
                        title="Cargar datos con verificación automática de actualizaciones">
                    <i class="bi bi-cloud-download me-1"></i>Cargar Datos
                </button>

                <!-- Card de estado de caché (muestra el progreso de carga) -->
                <div id="cache-status-card" class="cache-status-card" style="display: none;">
                    <div class="cache-status-content">
                        <i id="cache-status-icon" class="bi bi-lightning-charge-fill"></i>
                        <div class="cache-status-text">
                            <strong id="cache-status-title">Cargando...</strong>
                            <small id="cache-status-description">Verificando actualizaciones...</small>
                        </div>
                    </div>
                </div>

                <!-- Menú de opciones adicionales (⋮) -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm"
                            data-bs-toggle="dropdown"
                            aria-expanded="false"
                            aria-label="Menú de opciones"
                            id="options-menu-button">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item" href="#" id="save-favorites-option">
                                <i class="bi bi-star me-2"></i>Guardar como Favorito
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#" id="load-favorites-option" disabled>
                                <i class="bi bi-star-fill me-2"></i>Cargar Favorito
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" href="#" id="theme-toggle">
                                <i class="bi bi-moon-stars me-2" id="theme-icon"></i>
                                <span id="theme-text">Modo Oscuro</span>
                            </a>
                        </li>
                        <li class="px-3 py-2">
                            <label class="form-label small mb-1" style="font-size: 0.7rem; color: var(--app-text-muted);">
                                <i class="bi bi-rulers me-1"></i>Densidad de UI
                            </label>
                            <select id="density-select" class="form-select form-select-sm">
                                <option value="compact" selected>Compacta</option>
                                <option value="normal">Normal</option>
                                <option value="comfortable">Espaciada</option>
                            </select>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" href="#" id="show-help-option">
                                <i class="bi bi-question-circle me-2"></i>Ayuda
                            </a>
                        </li>
                    </ul>
                </div>

            </div>
        </section>
        <section id="description-section" class="mb-3" style="display: none;">
            <div id="description-box" class="alert alert-app-info p-2 small"></div>
        </section>
        


        <div class="row mb-2 g-2">
            <div class="col-md-8">
                <div id="status-bar" class="alert alert-app-status py-2 px-3 d-flex align-items-center mb-0">
                    <strong>Estado:</strong> <span id="status-message" class="ms-1">Idle</span>
                    <div id="spinner" class="spinner-border spinner-border-sm ms-auto text-primary-emphasis" role="status" style="display:none;">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div id="row-count-bar" class="alert alert-app-count py-2 px-3 d-flex justify-content-end align-items-center mb-0">
<strong>Filas:</strong> <span id="row-count-message">0</span>
                </div>
            </div>
        </div>

        <div class="row g-3">
            <aside id="left-panel" class="col-lg-3">
    <div class="card shadow-sm sticky-top" style="top: 1rem;">
        <div class="tab-bar">
            <button class="tab-button active" data-tab="TabFiltros"
                    data-bs-toggle="tooltip"
                    data-bs-placement="top"
                    title="Filtros por valores de columnas"><i class="bi bi-funnel-fill me-1"></i>Filtros</button>
            <button class="tab-button" data-tab="TabCodigos"
                    data-bs-toggle="tooltip"
                    data-bs-placement="top"
                    title="Filtros por SKU hijo, SKU padre, requerimientos y tickets"><i class="bi bi-upc-scan me-1"></i>Códigos</button>
            <button class="tab-button" data-tab="TabColumnas"
                    data-bs-toggle="tooltip"
                    data-bs-placement="top"
                    title="Selecciona qué columnas mostrar en la tabla"><i class="bi bi-layout-three-columns me-1"></i>Columnas</button>
        </div>

        <div class="card-body p-3" style="overflow-y: auto; max-height: calc(100vh - 250px);">

            <div id="TabFiltros" class="tab-content" style="display: block;">
                <div id="filter-controls">
                </div>
            </div>

            <div id="TabCodigos" class="tab-content">
                <div class="sku-filter-section mb-1">
                    <button class="btn btn-sm btn-outline-secondary w-100 text-start filter-collapse-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSkuHijo" aria-expanded="false" aria-controls="collapseSkuHijo">
                        <i class="bi bi-chevron-right me-2 filter-collapse-icon" id="iconSkuHijo"></i>
                        <strong>Filtro SKU Hijo</strong>
                    </button>
                    <div class="collapse" id="collapseSkuHijo">
                        <div class="card card-body p-2 mt-1 filter-select-card">
                            <label class="form-label form-label-sm small text-muted" hidden>Cargar desde archivo:</label>
                            <input type="file" id="sku-hijo-file" class="form-control form-control-sm mb-2" accept=".csv,.txt,.xlsx,.xls" hidden>
                            <div class="btn-group btn-group-sm w-100 mb-2" role="group" hidden>
                                <button id="upload-sku-hijo-button" class="btn btn-outline-action-secondary"><i class="bi bi-upload me-1"></i>Cargar Archivo</button>
                                <button id="clear-sku-hijo-button" class="btn btn-outline-danger-custom"><i class="bi bi-trash3 me-1"></i>Limpiar</button>
                            </div>
                            <div id="sku-hijo-status" class="form-text mt-1 small" hidden></div>
                            <hr class="my-2" hidden>
                            <label for="sku-hijo-input" class="form-label form-label-sm small text-muted">Coloca los SKU HIJO que necesitas filtrar:</label>
                            <textarea id="sku-hijo-input" class="form-control form-control-sm" rows="2" placeholder=""
                                      data-bs-toggle="tooltip"
                                      data-bs-placement="right"
                                      title="Ingresa códigos de SKU hijo separados por espacios, comas o saltos de línea"></textarea>
                            <div class="form-check mt-2">
                                <input type="checkbox" id="extend-sku-hijo-checkbox" class="form-check-input"
                                       data-bs-toggle="tooltip"
                                       data-bs-placement="right"
                                       title="Aperturar SKU hijo: Expande cada SKU hijo para incluir todos los SKUs padre relacionados en los resultados">
                                <label class="form-check-label small" for="extend-sku-hijo-checkbox">Aperturarlos</label>
                            </div>
                            <div class="form-check mt-2">
                                <input type="checkbox" id="batch-process-hijo-checkbox" class="form-check-input"
                                       data-bs-toggle="tooltip"
                                       data-bs-placement="right"
                                       title="Procesamiento por lotes: Divide automáticamente más de 500 SKUs en lotes de 500 y descarga múltiples archivos Excel secuencialmente">
                                <label class="form-check-label small" for="batch-process-hijo-checkbox">
                                    <i class="bi bi-lightning-charge-fill me-1"></i>Procesar por lotes (>500)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="sku-filter-section mb-1">
                     <button class="btn btn-sm btn-outline-secondary w-100 text-start filter-collapse-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSkuPadre" aria-expanded="false" aria-controls="collapseSkuPadre">
                        <i class="bi bi-chevron-right me-2 filter-collapse-icon" id="iconSkuPadre"></i>
                        <strong>Filtro SKU Padre</strong>
                    </button>
                    <div class="collapse" id="collapseSkuPadre">
                        <div class="card card-body p-2 mt-1 filter-select-card">
                            <label class="form-label form-label-sm small text-muted" hidden>Cargar desde archivo:</label>
                            <input type="file" id="sku-padre-file" class="form-control form-control-sm mb-2" accept=".csv,.txt,.xlsx,.xls" hidden>
                             <div class="btn-group btn-group-sm w-100 mb-2" role="group" hidden>
                                <button id="upload-sku-padre-button" class="btn btn-outline-action-secondary"><i class="bi bi-upload me-1"></i>Cargar Archivo</button>
                                <button id="clear-sku-padre-button" class="btn btn-outline-danger-custom"><i class="bi bi-trash3 me-1"></i>Limpiar</button>
                            </div>
                            <div id="sku-padre-status" class="form-text mt-1 small" hidden></div>
                            <hr class="my-2" hidden>
                            <label for="sku-padre-input" class="form-label form-label-sm small text-muted">Coloca los SKU PADRE que necesitas filtrar:</label>
                            <textarea id="sku-padre-input" class="form-control form-control-sm" rows="2" placeholder=""
                                      data-bs-toggle="tooltip"
                                      data-bs-placement="right"
                                      title="Ingresa códigos de SKU padre separados por espacios, comas o saltos de línea"></textarea>
                            <div class="form-check mt-2">
                                <input type="checkbox" id="batch-process-padre-checkbox" class="form-check-input"
                                       data-bs-toggle="tooltip"
                                       data-bs-placement="right"
                                       title="Procesamiento por lotes: Divide automáticamente más de 500 SKUs en lotes de 500 y descarga múltiples archivos Excel secuencialmente">
                                <label class="form-check-label small" for="batch-process-padre-checkbox">
                                    <i class="bi bi-lightning-charge-fill me-1"></i>Procesar por lotes (>500)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="ticket-filter-section" class="mb-3">
                    <button class="btn btn-sm btn-outline-secondary w-100 text-start filter-collapse-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTicketFilter" aria-expanded="false" aria-controls="collapseTicketFilter">
                        <i class="bi bi-chevron-right me-2 filter-collapse-icon" id="iconTicketFilter"></i>
                        <strong>Filtro por Requerimiento</strong>
                    </button>
                    <div class="collapse" id="collapseTicketFilter">
                        <div class="card card-body p-2 mt-1 filter-select-card">
                            <label class="form-label form-label-sm small text-muted" hidden>Cargar desde archivo:</label>
                            <input type="file" id="ticket-file-input" class="form-control form-control-sm mb-2" accept=".csv,.txt,.xlsx,.xls" hidden>
                            <div class="btn-group btn-group-sm w-100 mb-2" role="group" hidden>
                                <button id="upload-ticket-file-button" class="btn btn-outline-action-secondary"><i class="bi bi-upload me-1"></i>Cargar Archivo</button>
                                <button id="clear-ticket-file-button" class="btn btn-outline-danger-custom"><i class="bi bi-trash3 me-1"></i>Limpiar</button>
                            </div>
                            <div id="ticket-file-status" class="form-text mt-1 small" hidden></div>
                            <hr class="my-2" hidden>
                            <label for="ticket-filter-input" class="form-label form-label-sm small text-muted">Pegar los requerimientos que buscas:</label>
                            <textarea id="ticket-filter-input" class="form-control form-control-sm" rows="2" placeholder=""
                                      data-bs-toggle="tooltip"
                                      data-bs-placement="right"
                                      title="Ingresa números de requerimiento separados por espacios, comas o saltos de línea"></textarea>
                        </div>
                    </div>
                </div>
                <div id="lineamiento-filter-section" class="mb-3">
                    <button class="btn btn-sm btn-outline-secondary w-100 text-start filter-collapse-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLineamientoFilter" aria-expanded="false" aria-controls="collapseLineamientoFilter">
                        <i class="bi bi-chevron-right me-2 filter-collapse-icon" id="iconLineamientoFilter"></i>
                        <strong>Filtro por Ticket</strong>
                    </button>
                    <div class="collapse" id="collapseLineamientoFilter">
                        <div class="card card-body p-2 mt-1 filter-select-card">
                            <label for="lineamiento-filter-input" class="form-label form-label-sm small text-muted">Busca los tickets que necesitas:</label>
                            <textarea id="lineamiento-filter-input" class="form-control form-control-sm" rows="2" placeholder=""
                                      data-bs-toggle="tooltip"
                                      data-bs-placement="right"
                                      title="Ingresa números de ticket separados por espacios, comas o saltos de línea"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div id="TabColumnas" class="tab-content">
                <div id="column-selection-section">
                    <div class="alert alert-info py-1 px-2 mb-2 small" role="alert">
                        <i class="bi bi-info-circle me-1"></i>
                        <strong>Actualización instantánea:</strong> Los cambios en columnas se aplican automáticamente sin necesidad de "Aplicar Filtros".
                    </div>
                    <div id="columns-listbox-container" class="border rounded p-2 bg-white" style="max-height: 250px; overflow-y: auto;">
                        </div>
                    <div class="mt-2 btn-group btn-group-sm w-100" role="group">
                        <button id="select-all-cols-button" class="btn btn-outline-action-secondary"
                                data-bs-toggle="tooltip"
                                data-bs-placement="bottom"
                                title="Seleccionar todas las columnas disponibles">Todas</button>
                        <button id="deselect-all-cols-button" class="btn btn-outline-action-secondary"
                                data-bs-toggle="tooltip"
                                data-bs-placement="bottom"
                                title="Deseleccionar todas las columnas">Ninguna</button>
                    </div>
                </div>
            </div>

        </div>
        <div class="card-footer bg-white">
             <div class="d-grid gap-2">
                <button id="apply-filters-button" class="btn btn-secondary-action" disabled
                        data-bs-toggle="tooltip"
                        data-bs-placement="right"
                        title="Aplicar los filtros configurados a los datos cargados">
                    <span class="btn-content">
                        <i class="bi bi-check-circle-fill me-1"></i>Aplicar Filtros
                    </span>
                    <span class="btn-spinner" style="display: none;">
                        <span class="spinner-border spinner-border-sm"></span>
                        <span>Aplicando...</span>
                    </span>
                </button>
                <button id="clear-all-filters-button" class="btn btn-tertiary-action w-100" disabled
                        data-bs-toggle="tooltip"
                        data-bs-placement="right"
                        title="Limpiar todos los filtros activos y restaurar vista completa"><i class="bi bi-eraser-fill me-1"></i>Limpiar</button>
            </div>
        </div>
    </div>
</aside>
            <section id="right-panel" class="col-lg-9">
                <div class="card shadow-sm">
                     <div class="card-header app-card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <h5 class="mb-0 card-title-custom me-3"><i class="bi bi-table me-2"></i>Vista Previa de Datos</h5>
                            <div id="priority-legend" class="priority-legend d-none">
                                <i class="bi bi-info-circle-fill text-muted me-2"></i>
                                <span class="priority-legend-item">
                                    <span class="priority-indicator priority-indicator-1"></span>
                                    <span class="priority-text">P1 <span id="priority-1-percent" class="priority-percent">(0%)</span></span>
                                </span>
                                <span class="priority-legend-item">
                                    <span class="priority-indicator priority-indicator-2"></span>
                                    <span class="priority-text">P2 <span id="priority-2-percent" class="priority-percent">(0%)</span></span>
                                </span>
                                <span class="priority-legend-item">
                                    <span class="priority-indicator priority-indicator-3"></span>
                                    <span class="priority-text">P3 <span id="priority-3-percent" class="priority-percent">(0%)</span></span>
                                </span>
                            </div>
                        </div>
                        <div class="btn-group" role="group">
                            <button id="export-excel-button" class="btn btn-secondary-action btn-sm" disabled
                                    data-bs-toggle="tooltip"
                                    data-bs-placement="bottom"
                                    title="Exportar los datos filtrados a un archivo Excel con formato">
                                <span class="btn-content">
                                    <i class="bi bi-file-earmark-excel-fill me-1"></i>Descargar Excel
                                </span>
                                <span class="btn-spinner" style="display: none;">
                                    <span class="spinner-border spinner-border-sm"></span>
                                    <span>Exportando...</span>
                                </span>
                            </button>
                            <button id="export-csv-button" class="btn btn-secondary-action btn-sm ms-2" disabled
                                    data-bs-toggle="tooltip"
                                    data-bs-placement="bottom"
                                    title="Exportar los datos filtrados a un archivo CSV simple"><i class="bi bi-filetype-csv me-1"></i>Exportar CSV</button>
                            <button id="cancel-export-button" class="btn btn-danger btn-sm ms-2" style="display: none;">
                                <i class="bi bi-x-circle me-1"></i>Cancelar Exportación
                            </button>

                            <!-- Opciones de tabla -->
                            <div class="dropdown ms-2">
                                <button class="btn btn-outline-secondary btn-sm" type="button"
                                        id="table-options-dropdown" data-bs-toggle="dropdown"
                                        aria-expanded="false" disabled
                                        title="Opciones de visualización de la tabla">
                                    <i class="bi bi-gear-fill"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end table-options-menu" aria-labelledby="table-options-dropdown">
                                    <li class="dropdown-item-text">
                                        <div class="d-flex justify-content-between align-items-center py-1">
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-palette-fill me-2 text-primary"></i>
                                                <label for="priority-coloring-toggle" class="mb-0 user-select-none">
                                                    Coloreado por Prioridad
                                                </label>
                                            </div>
                                            <div class="form-check form-switch mb-0">
                                                <input class="form-check-input" type="checkbox" role="switch"
                                                       id="priority-coloring-toggle" disabled
                                                       title="Colorear filas según prioridad del SKU">
                                            </div>
                                        </div>
                                        <small class="text-muted d-block mt-1" style="margin-left: 1.75rem;">
                                            Resalta visualmente las prioridades
                                        </small>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-2">
                        <div id="table-view-container">
        <div id="top-scroll" class="top-scroll-container">
            <div class="scroll-dummy"></div>
        </div>

        <div id="data-table-wrapper" class="table-responsive-wrapper">
            <table id="data-table" class="table table-striped table-bordered table-hover table-sm">
                <thead class="app-table-header"></thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="pagination-container" class="my-2 d-flex justify-content-center"></div>
    </div>
                    </div>
                </div>
                
                <!--<div class="card shadow-sm mt-3">
                    <div class="card-header app-card-header">
                        <h5 class="mb-0">
                            <button class="btn btn-link-custom text-decoration-none card-title-custom p-0" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProcesos" aria-expanded="false" aria-controls="collapseProcesos">
                                <i class="bi bi-terminal me-2"></i>Procesos (Backend) <i class="bi bi-chevron-down collapse-icon ms-1"></i>
                            </button>
                        </h5>
                    </div>
                    <div class="collapse" id="collapseProcesos">
                        <div class="card-body p-0">
                             <div id="console-output" class="console-output-custom p-2 small">
                            </div>
                        </div>
                    </div>
                </div>-->
            </section>
        </div> 
    </div> 

    <!-- Contenedor para mensajes contextuales -->
    <div id="context-messages" class="context-messages-container"></div>

    <footer class="app-footer text-white text-center py-3 mt-auto">
        <p class="mb-0 small">&copy; <span id="current-year"></span class="pie"> APP Reportes Publicación y contenido. Todos los derechos reservados. Desarrollo a cargo de Rodrigo Jara para uso exclusivo del departamento de publicación y contenido. Observaciones y sugerencias a rjarad@ripley.com</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- Shepherd.js para tour interactivo -->
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@11.2.0/dist/js/shepherd.min.js"></script>

    <script type="module" src="/reportes/static/script.js"></script>
    <script type="module" src="/reportes/static/tour.js"></script>

    <script>
        if(document.getElementById('current-year')) {
            document.getElementById('current-year').textContent = new Date().getFullYear();
        }
    </script>

    <!--<button id="suggestion-fab" class="btn btn-warning rounded-circle shadow" title="Enviar Sugerencia">
        <i class="bi bi-lightbulb-fill"></i>
    </button>-->

    <div class="modal fade" id="suggestionModal" tabindex="-1" aria-labelledby="suggestionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="suggestionModalLabel">Enviar Sugerencia</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <p>Agradecemos tus comentarios para mejorar la aplicación.</p>
            <textarea id="suggestion-text-area" class="form-control" rows="8" placeholder="Escribe aquí tu sugerencia o reporta un problema..."></textarea>
            <div id="suggestion-status" class="mt-2"></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button id="send-suggestion-button" type="button" class="btn btn-primary">Enviar</button>
        </div>
        </div>
    </div>
    </div>

    <!-- Modal de Verificación de Cache -->
    <div class="modal fade" id="cacheVerificationModal" tabindex="-1" aria-labelledby="cacheVerificationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="cacheVerificationModalLabel">
                <i class="bi bi-search me-2"></i>Verificación de Actualización - <span id="verification-database-name"></span>
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div id="verification-loading" class="text-center py-4" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Verificando...</span>
                </div>
                <p class="mt-2">Verificando actualizaciones en SharePoint...</p>
            </div>
            <div id="verification-result" style="display: none;">
                <div id="verification-alert" class="alert" role="alert">
                    <h6 class="alert-heading"><i id="verification-icon"></i> <span id="verification-title"></span></h6>
                    <p id="verification-message" class="mb-0"></p>
                    <hr>
                    <p id="verification-details" class="mb-0 small text-muted"></p>
                    <div id="verification-timestamps" class="mt-2 small">
                        <div><strong>Cache local:</strong> <span id="cache-timestamp"></span></div>
                        <div><strong>SharePoint:</strong> <span id="remote-timestamp"></span></div>
                    </div>
                </div>
            </div>
            <div id="verification-error" style="display: none;">
                <div class="alert alert-danger" role="alert">
                    <h6 class="alert-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i>Error de Verificación</h6>
                    <p id="verification-error-message"></p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button id="reload-data-btn" type="button" class="btn btn-warning" style="display: none;" data-bs-dismiss="modal">
                <i class="bi bi-arrow-clockwise me-1"></i>Recargar Datos
            </button>
        </div>
        </div>
    </div>
    </div>

    <!-- Modal Resultados Vacíos -->
    <div class="modal fade" id="emptyResultsModal" tabindex="-1" aria-labelledby="emptyResultsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title" id="emptyResultsModalLabel">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>No se Encontraron Resultados
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>La base de datos <strong>no contiene ninguno</strong> de los valores consultados.</p>
                    <div class="alert alert-info mb-3">
                        <strong>Valores buscados:</strong> <span id="empty-total-buscados">0</span><br>
                        <strong>Valores encontrados:</strong> 0
                        <hr class="my-2">
                        <small><strong>Desglose:</strong><br><span id="empty-detalle-busqueda"></span></small>
                    </div>
                    <div class="alert alert-secondary small">
                        <i class="bi bi-info-circle-fill me-1"></i>
                        En caso de consultas o dudas respecto a los valores no encontrados,
                        favor contactar a <strong>msilvao@ripley.com</strong>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Resultados Parciales -->
    <div class="modal fade" id="partialResultsModal" tabindex="-1" aria-labelledby="partialResultsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title" id="partialResultsModalLabel">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>Resultados Parciales
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>La consulta devolvió resultados, pero <strong>no todos los valores</strong> estaban presentes en la base de datos.</p>
                    <div class="alert alert-warning mb-3">
                        <strong>Valores buscados:</strong> <span id="partial-total-buscados">0</span><br>
                        <strong>Valores encontrados:</strong> <span id="partial-total-encontrados">0</span><br>
                        <strong>Valores NO encontrados:</strong> <span id="partial-total-no-encontrados">0</span>
                        <hr class="my-2">
                        <small><strong>Desglose no encontrados:</strong><br><span id="partial-detalle-no-encontrados"></span></small>
                    </div>
                    <div class="alert alert-secondary small">
                        <i class="bi bi-info-circle-fill me-1"></i>
                        En caso de consultas o dudas respecto a los valores no encontrados,
                        favor contactar a <strong>msilvao@ripley.com</strong>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button id="download-not-found-from-modal" type="button" class="btn btn-warning">
                        <i class="bi bi-file-earmark-text-fill me-1"></i>Descargar Reporte No Encontrados
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Selector de Columnas -->
    <div class="modal fade" id="columnSelectorModal" tabindex="-1" aria-labelledby="columnSelectorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content column-selector-modal">
                <div class="modal-header bg-light border-bottom">
                    <h6 class="modal-title fw-semibold mb-0" id="columnSelectorModalLabel">
                        <i class="bi bi-sliders me-1 text-primary"></i>Optimizar Carga
                    </h6>
                    <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-2">
                    <!-- Banner informativo ultra compacto -->
                    <div class="alert alert-info py-1 px-2 mb-2 d-flex align-items-center" style="font-size: 0.75rem;">
                        <i class="bi bi-lightning-charge-fill me-1" style="font-size: 0.875rem;"></i>
                        <span><strong>Tip:</strong> Selecciona solo las columnas necesarias</span>
                    </div>

                    <!-- Selector de columnas esenciales -->
                    <div class="mb-2">
                        <div class="d-flex align-items-center mb-1">
                            <i class="bi bi-star-fill text-warning me-1" style="font-size: 0.75rem;"></i>
                            <span class="text-secondary fw-semibold" style="font-size: 0.8rem;">Esenciales</span>
                        </div>
                        <div id="essential-columns-container" class="columns-grid">
                            <!-- Se llenarán dinámicamente -->
                        </div>
                    </div>

                    <hr class="my-2">

                    <!-- Selector de columnas adicionales -->
                    <div class="mb-2">
                        <div class="d-flex align-items-center mb-1">
                            <i class="bi bi-grid-3x3-gap me-1 text-primary" style="font-size: 0.75rem;"></i>
                            <span class="text-secondary fw-semibold" style="font-size: 0.8rem;">Adicionales</span>
                        </div>
                        <div class="input-group input-group-sm mb-1">
                            <span class="input-group-text bg-white p-1"><i class="bi bi-search" style="font-size: 0.75rem;"></i></span>
                            <input type="text" class="form-control form-control-sm" id="column-search-input" placeholder="Buscar..." style="font-size: 0.75rem;">
                        </div>
                        <div id="additional-columns-container" class="columns-grid columns-scrollable">
                            <!-- Se llenarán dinámicamente -->
                        </div>
                    </div>

                    <!-- Información de selección ultra compacta -->
                    <div class="selection-info-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-check2-square me-1 text-primary" style="font-size: 0.75rem;"></i>
                                <span style="font-size: 0.7rem;" class="text-muted me-1">Selec:</span>
                                <span id="selected-columns-count" class="badge bg-primary" style="font-size: 0.65rem;">0</span>
                                <span style="font-size: 0.7rem;" class="text-muted ms-1">/ <span id="total-columns-count">0</span></span>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-hdd me-1 text-success" style="font-size: 0.75rem;"></i>
                                <span style="font-size: 0.7rem;" class="text-muted me-1">RAM:</span>
                                <strong id="estimated-ram" class="text-success" style="font-size: 0.75rem;">~0 GB</strong>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light border-top py-1 px-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary px-2 py-1" onclick="deselectAllColumns()" style="font-size: 0.75rem;">
                        <i class="bi bi-x-square me-1"></i>Ninguna
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary px-2 py-1" onclick="selectAllColumns()" style="font-size: 0.75rem;">
                        <i class="bi bi-check-all me-1"></i>Todas
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary px-2 py-1" onclick="restoreDefaultColumns()" style="font-size: 0.75rem;">
                        <i class="bi bi-arrow-counterclockwise me-1"></i>Restaurar
                    </button>
                    <div class="vr mx-1"></div>
                    <button type="button" class="btn btn-sm btn-secondary px-2 py-1" data-bs-dismiss="modal" style="font-size: 0.75rem;">Cancelar</button>
                    <button type="button" class="btn btn-sm btn-primary px-2 py-1" id="confirm-column-selection-btn" style="font-size: 0.75rem;">
                        <i class="bi bi-rocket-takeoff-fill me-1"></i>Cargar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Quick Actions -->
    <div class="modal fade" id="quickActionsModal" tabindex="-1" aria-labelledby="quickActionsModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-gradient-primary text-white">
                    <h5 class="modal-title" id="quickActionsModalLabel">
                        <i class="bi bi-lightning-charge-fill me-2"></i>¿Qué deseas hacer?
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="text-muted mb-4">Elige una acción rápida para comenzar tu consulta:</p>

                    <div class="row g-3">
                        <!-- Opción Chile -->
                        <div class="col-12">
                            <div class="action-card" id="quick-action-chile" role="button" tabindex="0">
                                <div class="action-icon bg-primary text-white">
                                    <i class="bi bi-flag-fill"></i>
                                </div>
                                <div class="action-content">
                                    <h6 class="action-title">Consultar Chile</h6>
                                    <p class="action-description">Universo completo de productos y órdenes de trabajo</p>
                                </div>
                                <div class="action-arrow">
                                    <i class="bi bi-arrow-right"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Opción Perú -->
                        <div class="col-12">
                            <div class="action-card" id="quick-action-peru" role="button" tabindex="0">
                                <div class="action-icon bg-success text-white">
                                    <i class="bi bi-flag-fill"></i>
                                </div>
                                <div class="action-content">
                                    <h6 class="action-title">Consultar Perú</h6>
                                    <p class="action-description">Datos de diseño, redacción y staff</p>
                                </div>
                                <div class="action-arrow">
                                    <i class="bi bi-arrow-right"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Opción Favoritos -->
                        <div class="col-12">
                            <div class="action-card" id="quick-action-favorites" role="button" tabindex="0">
                                <div class="action-icon bg-warning text-dark">
                                    <i class="bi bi-star-fill"></i>
                                </div>
                                <div class="action-content">
                                    <h6 class="action-title">Cargar Favorito</h6>
                                    <p class="action-description">Accede rápidamente a tus consultas guardadas</p>
                                </div>
                                <div class="action-arrow">
                                    <i class="bi bi-arrow-right"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 text-center">
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            También puedes configurar manualmente desde la barra superior
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Procesamiento por Lotes -->
    <div class="modal fade" id="batchProcessModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="batchProcessModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="batchProcessModalLabel">
                        <i class="bi bi-lightning-charge-fill me-2"></i>Procesamiento por Lotes
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <div class="spinner-border text-primary mb-3" role="status" id="batch-spinner">
                            <span class="visually-hidden">Procesando...</span>
                        </div>
                        <h6 id="batch-status-title" class="fw-bold">Procesando lote <span id="batch-current">1</span> de <span id="batch-total">1</span></h6>
                        <div class="progress mt-3" style="height: 25px;">
                            <div id="batch-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                                 role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                <span id="batch-progress-text" class="fw-bold">0%</span>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info" id="batch-info-alert">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <strong>Lote actual:</strong><br>
                        <span id="batch-info-text">Preparando descarga...</span>
                    </div>

                    <div class="alert alert-success d-none" id="batch-ready-alert">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <strong>¡Lote listo para descargar!</strong><br>
                        Haz clic en "Descargar Excel" para obtener los resultados de este lote.
                    </div>

                    <!-- Estado: Proceso Completado -->
                    <div class="d-none" id="batch-completed-section">
                        <div class="text-center mb-3">
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                            <h5 class="mt-2 text-success fw-bold" id="batch-completed-title">¡Proceso Completado!</h5>
                            <p class="text-muted" id="batch-completed-summary">Se procesaron X lotes exitosamente.</p>
                        </div>
                        <div class="alert alert-warning d-none" id="batch-notfound-alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <strong>SKUs No Encontrados:</strong><br>
                            <span id="batch-notfound-count">0</span> valores no fueron encontrados en la base de datos.
                            <br><small class="text-muted">Puedes descargar el listado completo en formato TXT.</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="batch-cancel-btn">
                        <i class="bi bi-x-circle me-1"></i>Cancelar Proceso
                    </button>
                    <button type="button" class="btn btn-success d-none" id="batch-download-btn">
                        <i class="bi bi-download me-1"></i>Descargar Excel
                    </button>
                    <button type="button" class="btn btn-warning d-none" id="batch-download-notfound-btn">
                        <i class="bi bi-file-earmark-text me-1"></i>Descargar No Encontrados (.txt)
                    </button>
                    <button type="button" class="btn btn-secondary d-none" id="batch-close-btn" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg me-1"></i>Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>


</body>
</html>